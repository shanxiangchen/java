<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.app.mapper.BankMessageRecordMapper">

	<resultMap type="BankMessageRecord" id="recordResultMapper">
		<id column="record_id" property="recordId"/>
		<result column="date" property="date"/>
		<result column="fail_times" property="failTimes"/>
		<result column="is_success" property="isSuccess"/>
		<result column="message_code" property="messageCode"/>
		<association property="bankMessageAllocation" javaType="BankMessageAllocation" column="message_code" resultMap="allocationResult"></association>
	</resultMap>
	
	<resultMap type="BankMessageAllocation" id="allocationResult">
		<id column="message_id" property="messageId"/>
		<result column="allocation_name" property="allocationName"/>
		<result column="times" property="times"/>
		<result column="interval_time" property="intervalTime"/>
		<result column="message_code" property="messageCode"/>
	</resultMap>
	
	<select id="selectBankMessageRecordPageList" parameterType="bankMessageRecord" resultMap="recordResultMapper">
		select r.*,a.allocation_name from bank_message_record r,bank_message_allocation a where 1=1 and is_delete = 0 
		and r.message_code= a.message_code
		<if test="date != null and date != ''">
			and r.date like concat('%',DATE_FORMAT(#{date}, '%Y-%m-%d'),'%')
		</if>
		<if test="messageCode != null and messageCode != ''">
			and r.message_code = #{messageCode}
		</if>
		order by r.date desc, record_id asc
	</select>
	
	<update id="deleteMessageRecord" parameterType="int" >
		update bank_message_record set is_delete = 1 where record_id = #{bankMessageRecordId}
	</update>
	
	<update id="updateMessageRecordById" parameterType="bankMessageRecord">
		update bank_message_record set fail_times = 1 where record_id = #{recordId}
	</update>
	
</mapper>